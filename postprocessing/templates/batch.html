<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFå›¾åƒæˆªå–å™¨ - æ‰¹é‡å¤„ç†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }
        .nav-links a {
            color: #007bff;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border: 1px solid #007bff;
            border-radius: 4px;
        }
        .nav-links a:hover {
            background-color: #007bff;
            color: white;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress {
            display: none;
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .form-text {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        .example-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        .example-box h4 {
            margin-top: 0;
            color: #495057;
        }
        .book-result {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 0 5px 5px 0;
        }
        .book-result.success {
            border-left-color: #28a745;
        }
        .book-result.failed {
            border-left-color: #dc3545;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDFå›¾åƒæˆªå–å™¨ - æ‰¹é‡å¤„ç†</h1>
        
        <div class="nav-links">
            <a href="/">å•æ–‡ä»¶å¤„ç†</a>
            <a href="/batch">æ‰¹é‡å¤„ç†</a>
            <a href="/api">APIæ–‡æ¡£</a>
        </div>
        
        <form id="batchForm">
            <div class="form-group">
                <label for="resultsFolder">ç»“æœæ–‡ä»¶å¤¹è·¯å¾„</label>
                <input type="text" id="resultsFolder" name="results_folder" required value="/home/zhoujuncheng/2025è‡ªæœ‰åº“_0807_sglang/results">
                <small class="form-text">åŒ…å«ä¹¦ç±ç»“æœçš„æ ¹ç›®å½•ï¼Œæ¯ä¸ªå­æ–‡ä»¶å¤¹ä»£è¡¨ä¸€æœ¬ä¹¦ç±ï¼ŒåŒ…å«å¯¹åº”çš„JSONæ–‡ä»¶ï¼ˆä¹¦ç±åç§°_middle.jsonï¼‰</small>
            </div>
            
            <div class="form-group">
                <label for="pdfBaseFolder">PDFæœç´¢åŸºç¡€ç›®å½•</label>
                <input type="text" id="pdfBaseFolder" name="pdf_base_folder" required value="/home/zhoujuncheng/mineru_pdf/xyzhwb/oss-cn-huhehaote.aliyuncs.com">
                <small class="form-text">PDFæ–‡ä»¶çš„åŸºç¡€æœç´¢ç›®å½•ï¼Œç³»ç»Ÿå°†åœ¨æ­¤ç›®å½•ä¸‹é€’å½’æœç´¢ä¸ä¹¦ç±åç§°åŒ¹é…çš„PDFæ–‡ä»¶</small>
            </div>
            
            <div class="form-group">
                <label for="outputBaseDir">è¾“å‡ºåŸºç¡€ç›®å½•ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="outputBaseDir" name="output_base_dir" value="/home/zhoujuncheng/batch_output">
                <small class="form-text">æ‰¹é‡å¤„ç†ç»“æœçš„è¾“å‡ºåŸºç¡€ç›®å½•ï¼Œç•™ç©ºå°†åœ¨ç»“æœæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºbatch_outputç›®å½•</small>
            </div>
            
            <div class="form-group" id="resumeGroup" style="display: none;">
                <label for="resumeTaskId">æ¢å¤ä»»åŠ¡IDï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="resumeTaskId" name="resume_task_id" placeholder="è¾“å…¥è¦æ¢å¤çš„ä»»åŠ¡ID">
                <small class="form-text">å¦‚æœéœ€è¦æ¢å¤ä¸­æ–­çš„ä»»åŠ¡ï¼Œè¯·è¾“å…¥ä»»åŠ¡ID</small>
            </div>
            
            <div class="form-options">
                <label>
                    <input type="checkbox" id="enableMultiprocess" checked> å¯ç”¨å¤šè¿›ç¨‹å¤„ç† (æœ€å¤š 32 ä¸ªè¿›ç¨‹)
                </label>
                <label>
                    <input type="checkbox" id="enableResume" onchange="toggleResumeInput()"> æ¢å¤ä¸­æ–­çš„ä»»åŠ¡
                </label>
                <label>
                    <input type="checkbox" id="enableSmartResume" checked> æ™ºèƒ½è·³è¿‡å·²å¤„ç†æ–‡ä»¶
                </label>
            </div>
            
            <div class="info-box" id="smartResumeInfo">
                <h4>ğŸ’¡ æ™ºèƒ½æ¢å¤è¯´æ˜ï¼š</h4>
                <p>å¯ç”¨åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥è¾“å‡ºç›®å½•ä¸­å·²å®Œæˆçš„ä¹¦ç±ï¼Œè·³è¿‡å·²æœ‰çš„å¤„ç†ç»“æœï¼Œä»æœªå¤„ç†çš„ä¹¦ç±å¼€å§‹ç»§ç»­æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ï¼š</p>
                <ul>
                    <li>âœ… é¿å…é‡å¤å¤„ç†å·²å®Œæˆçš„ä¹¦ç±</li>
                    <li>âœ… è‡ªåŠ¨æ¢å¤æ„å¤–ä¸­æ–­çš„æ‰¹é‡ä»»åŠ¡</li>
                    <li>âœ… æ”¯æŒå¢é‡å¤„ç†æ–°å¢çš„ä¹¦ç±</li>
                    <li>ğŸš€ æŒ‰éœ€PDFæœç´¢ï¼šæ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹æœç´¢è‡ªå·±çš„ä¹¦ç±ï¼Œå……åˆ†åˆ©ç”¨å¤šçº¿ç¨‹ä¼˜åŠ¿</li>
                    <li>âš¡ ç²¾ç¡®æœç´¢ï¼šç›´æ¥ä½¿ç”¨ä¹¦ç±åç§°æœç´¢ï¼Œé¿å…å…¨é‡ç¼“å­˜æ„å»ºæ—¶é—´</li>
                </ul>
            </div>
            
            <div class="example-box">
                <h4>æ–‡ä»¶å¤¹ç»“æ„ç¤ºä¾‹ï¼š</h4>
                <pre>
ç»“æœæ–‡ä»¶å¤¹/
â”œâ”€â”€ ä¹¦ç±1/
â”‚   â””â”€â”€ ä¹¦ç±1_middle.json
â”œâ”€â”€ ä¹¦ç±2/
â”‚   â””â”€â”€ ä¹¦ç±2_middle.json
â””â”€â”€ ä¹¦ç±3/
    â””â”€â”€ ä¹¦ç±3_middle.json

PDFæœç´¢åŸºç¡€ç›®å½•/
â”œâ”€â”€ 20250807/
â”œâ”€â”€ 20250815/
â”œâ”€â”€ 20250818/
â””â”€â”€ 20250819/
    â””â”€â”€ 000005/
        â””â”€â”€ å·¥ä¸šæŠ€æœ¯ç›¸å…³ä¹¦ç±æ•°æ®é›†æˆ/
            â””â”€â”€ åŸå­èƒ½æŠ€æœ¯/
                â””â”€â”€ zh/
                    â””â”€â”€ ä¹¦ç±1.pdf

ä½¿ç”¨findå‘½ä»¤æœç´¢PDF: find ./ -name "ä¹¦ç±åç§°*"
                </pre>
            </div>
            
            <button type="submit" class="btn" id="submitBtn">å¼€å§‹æ‰¹é‡å¤„ç†</button>
        </form>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <p id="progressText">æ­£åœ¨æ£€æµ‹ä¹¦ç±æ•°é‡...</p>
            <div class="progress-stats" id="progressStats"></div>
            <div class="progress-details" id="progressDetails">
                <div class="current-book" id="currentBook"></div>
                <div class="task-info" id="taskInfo"></div>
                <div class="estimated-time" id="estimatedTime"></div>
            </div>
            <div class="task-controls" id="taskControls" style="display: none;">
                <button class="btn btn-warning" onclick="cancelTask(false)">ğŸ›‘ å–æ¶ˆä»»åŠ¡</button>
                <button class="btn btn-danger" onclick="cancelTask(true)">âš ï¸ å¼ºåˆ¶ä¸­æ–­</button>
                <button class="btn btn-info" onclick="viewTaskList()">ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡</button>
            </div>
        </div>
        
        <div class="result" id="result"></div>
    </div>

    <script>
        let currentTaskId = null;
        let progressTimer = null;
        
        // åˆ‡æ¢æ¢å¤è¾“å…¥æ¡†æ˜¾ç¤º
        function toggleResumeInput() {
            const enableResume = document.getElementById('enableResume').checked;
            const resumeGroup = document.getElementById('resumeGroup');
            resumeGroup.style.display = enableResume ? 'block' : 'none';
        }
        
        // å®æ—¶æ›´æ–°ä»»åŠ¡è¿›åº¦
        async function updateTaskProgress(taskId) {
            try {
                const response = await fetch(`/task-status/${taskId}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    document.getElementById('progressFill').style.width = data.progress_percentage + '%';
                    document.getElementById('progressPercentage').textContent = data.progress_percentage.toFixed(1) + '%';
                    
                    // æ›´æ–°æ–‡æœ¬
                    document.getElementById('progressText').textContent = 
                        `çŠ¶æ€: ${getStatusText(data.status)} - å·²å®Œæˆ ${data.processed_books}/${data.total_books} æœ¬ä¹¦ç±`;
                    
                    // æ›´æ–°å½“å‰ä¹¦ç±
                    document.getElementById('currentBook').textContent = 
                        data.current_book ? `å½“å‰: ${data.current_book}` : '';
                    
                    // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
                    document.getElementById('taskInfo').textContent = `ä»»åŠ¡ID: ${data.task_id}`;
                    
                    // æ›´æ–°é¢„è®¡å‰©ä½™æ—¶é—´
                    if (data.estimated_remaining) {
                        const minutes = Math.floor(data.estimated_remaining / 60);
                        const seconds = Math.floor(data.estimated_remaining % 60);
                        document.getElementById('estimatedTime').textContent = 
                            `é¢„è®¡å‰©ä½™: ${minutes}åˆ†${seconds}ç§’`;
                    }
                    
                    // å¦‚æœä»»åŠ¡å®Œæˆï¼Œåœæ­¢å®šæ—¶å™¨
                    if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                        clearInterval(progressTimer);
                        document.getElementById('taskControls').style.display = 'none';
                        
                        if (data.status === 'completed') {
                            // è·å–æœ€ç»ˆç»“æœ
                            setTimeout(() => location.reload(), 2000);
                        }
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error);
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å¤„ç†',
                'running': 'è¿è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        // å–æ¶ˆä»»åŠ¡
        async function cancelTask(force = false) {
            if (!currentTaskId) return;
            
            const confirmMessage = force 
                ? 'ç¡®å®šè¦å¼ºåˆ¶ä¸­æ–­ä»»åŠ¡å—ï¼Ÿè¿™ä¼šç«‹å³ç»ˆæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸å®Œæ•´ã€‚'
                : 'ç¡®å®šè¦å–æ¶ˆä»»åŠ¡å—ï¼Ÿæ­£åœ¨å¤„ç†ä¸­çš„ä¹¦ç±ä¼šå®Œæˆï¼Œä½†ä¸ä¼šå¼€å§‹æ–°çš„å¤„ç†ã€‚';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const url = force 
                    ? `/cancel-task/${currentTaskId}?force=true`
                    : `/cancel-task/${currentTaskId}`;
                
                const response = await fetch(url, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // æ˜¾ç¤ºå–æ¶ˆç»“æœ
                    const messageType = force ? 'warning' : 'info';
                    showResult(messageType, `
                        <h3>${force ? 'âš ï¸ å¼ºåˆ¶ä¸­æ–­å®Œæˆ' : 'ğŸ›‘ ä»»åŠ¡å–æ¶ˆå®Œæˆ'}</h3>
                        <p>${data.message}</p>
                        <p><strong>ä»»åŠ¡ID:</strong> ${data.task_id}</p>
                        ${data.force_cancelled ? '<p style="color: #dc3545;"><strong>æ³¨æ„:</strong> å·²å¼ºåˆ¶ä¸­æ–­æ‰€æœ‰è¿›ç¨‹</p>' : ''}
                    `);
                    
                    // åœæ­¢è¿›åº¦æ›´æ–°
                    clearInterval(progressTimer);
                    document.getElementById('taskControls').style.display = 'none';
                    document.getElementById('progressText').textContent = force ? 'ä»»åŠ¡å·²å¼ºåˆ¶ä¸­æ–­' : 'ä»»åŠ¡å·²å–æ¶ˆ';
                    
                } else {
                    const errorData = await response.json();
                    alert(`å–æ¶ˆå¤±è´¥: ${errorData.detail}`);
                }
            } catch (error) {
                console.error('å–æ¶ˆä»»åŠ¡å¤±è´¥:', error);
                alert(`å–æ¶ˆä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
        }
        
        // æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
        async function viewTaskList() {
            try {
                const response = await fetch('/list-tasks');
                if (response.ok) {
                    const data = await response.json();
                    let taskListHtml = '<h3>ä»»åŠ¡åˆ—è¡¨</h3><ul>';
                    
                    data.tasks.forEach(task => {
                        const startTime = new Date(task.start_time * 1000).toLocaleString();
                        taskListHtml += `<li>
                            <strong>ID:</strong> ${task.task_id.substring(0, 8)}...<br>
                            <strong>çŠ¶æ€:</strong> ${getStatusText(task.status)}<br>
                            <strong>è¿›åº¦:</strong> ${task.processed_books}/${task.total_books} (${task.progress_percentage.toFixed(1)}%)<br>
                            <strong>å¼€å§‹æ—¶é—´:</strong> ${startTime}<br>
                            <strong>æ¶ˆæ¯:</strong> ${task.message}
                        </li>`;
                    });
                    
                    taskListHtml += '</ul>';
                    document.getElementById('result').innerHTML = taskListHtml;
                    document.getElementById('result').style.display = 'block';
                }
            } catch (error) {
                console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // è¡¨å•æäº¤
        document.getElementById('batchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const progress = document.getElementById('progress');
            const result = document.getElementById('result');
            const resultsFolder = document.getElementById('resultsFolder').value;
            
            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'å¤„ç†ä¸­...';
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progress.style.display = 'block';
            result.style.display = 'none';
            
            // å…ˆè·å–å­ç›®å½•æ•°é‡å’Œå·²å¤„ç†çŠ¶æ€
            let totalBooks = 0;
            let processedBooks = 0;
            let alreadyProcessed = 0;
            
            try {
                // æ£€æŸ¥æ™ºèƒ½æ¢å¤æ˜¯å¦å¯ç”¨
                const enableSmartResume = document.getElementById('enableSmartResume').checked;
                
                if (enableSmartResume) {
                    // æ£€æŸ¥å·²å¤„ç†çš„ä¹¦ç±
                    const checkResponse = await fetch(`/check-processed-books?results_folder=${encodeURIComponent(resultsFolder)}&output_base_dir=${encodeURIComponent(outputBaseDir)}`);
                    if (checkResponse.ok) {
                        const checkData = await checkResponse.json();
                        totalBooks = checkData.total_books;
                        alreadyProcessed = checkData.processed_books;
                        
                        console.log(`å‘ç° ${totalBooks} æœ¬ä¹¦ç±ï¼Œå…¶ä¸­ ${alreadyProcessed} æœ¬å·²å¤„ç†`);
                        
                        // æ˜¾ç¤ºæ™ºèƒ½æ¢å¤ä¿¡æ¯
                        if (alreadyProcessed > 0) {
                            document.getElementById('progressText').textContent = 
                                `æ™ºèƒ½æ¢å¤: è·³è¿‡ ${alreadyProcessed} æœ¬å·²å¤„ç†çš„ä¹¦ç±ï¼Œå¼€å§‹å¤„ç†å‰©ä½™ ${checkData.pending_books} æœ¬...`;
                        } else {
                            document.getElementById('progressText').textContent = `å‡†å¤‡å¤„ç† ${totalBooks} æœ¬ä¹¦ç±ï¼ŒPDFæ–‡ä»¶å°†åœ¨å¤„ç†æ—¶æŒ‰éœ€æœç´¢...`;
                        }
                        
                        document.getElementById('progressStats').innerHTML = `
                            <div style="text-align: center; margin-top: 10px; color: #6c757d;">
                                å·²å®Œæˆ: <span id="processedCount">${alreadyProcessed}</span> / ${totalBooks}
                                ${alreadyProcessed > 0 ? `<br><small style="color: #28a745;">âœ… æ™ºèƒ½è·³è¿‡ ${alreadyProcessed} æœ¬å·²å¤„ç†ä¹¦ç±</small>` : ''}
                            </div>
                        `;
                        
                        // å¦‚æœæœ‰å·²å¤„ç†çš„ä¹¦ç±ï¼Œæ˜¾ç¤ºå®Œæˆç™¾åˆ†æ¯”
                        if (alreadyProcessed > 0) {
                            const percentage = checkData.completion_percentage;
                            document.getElementById('progressFill').style.width = percentage + '%';
                            document.getElementById('progressPercentage').textContent = percentage.toFixed(1) + '%';
                        }
                    }
                } else {
                    // å¸¸è§„æ¨¡å¼ï¼Œåªè·å–æ€»æ•°
                    const countResponse = await fetch(`/get-subdirs-count?results_folder=${encodeURIComponent(resultsFolder)}`);
                    if (countResponse.ok) {
                        const countData = await countResponse.json();
                        totalBooks = countData.total_books;
                        console.log(`å‘ç° ${totalBooks} æœ¬ä¹¦ç±å¾…å¤„ç†`);
                        
                        document.getElementById('progressText').textContent = `å‡†å¤‡å¤„ç† ${totalBooks} æœ¬ä¹¦ç±ï¼ŒPDFæ–‡ä»¶å°†åœ¨å¤„ç†æ—¶æŒ‰éœ€æœç´¢...`;
                        document.getElementById('progressStats').innerHTML = `
                            <div style="text-align: center; margin-top: 10px; color: #6c757d;">
                                å·²å®Œæˆ: <span id="processedCount">0</span> / ${totalBooks}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.warn('è·å–ä¹¦ç±ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è¿›åº¦æ˜¾ç¤º');
                document.getElementById('progressText').textContent = 'å¼€å§‹å¤„ç†...';
            }
            
            // æ ¹æ®æ€»ä¹¦ç±æ•°é‡è®¾ç½®è¿›åº¦æ¡
            let progressValue = 0;
            let estimatedProcessedBooks = 0;
            const progressInterval = setInterval(() => {
                if (totalBooks > 0) {
                    // ç¼“æ…¢é€’å¢ä¼°ç®—çš„å·²å¤„ç†ä¹¦ç±æ•°é‡
                    const maxEstimated = Math.min(totalBooks * 0.9, totalBooks - 1); // æœ€å¤šåˆ°90%æˆ–æ€»æ•°-1
                    if (estimatedProcessedBooks < maxEstimated) {
                        estimatedProcessedBooks += 0.05; // æ¯æ¬¡å¢åŠ 0.05æœ¬ä¹¦
                    }
                    
                    // åŸºäºä¼°ç®—çš„è¿›åº¦
                    const targetProgress = Math.min((estimatedProcessedBooks / totalBooks) * 90, 90);
                    progressValue += (targetProgress - progressValue) * 0.2;
                    
                    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                    const processedCountElement = document.getElementById('processedCount');
                    if (processedCountElement) {
                        processedCountElement.textContent = Math.floor(estimatedProcessedBooks);
                    }
                } else {
                    // å›é€€åˆ°æ¨¡æ‹Ÿè¿›åº¦
                    progressValue += Math.random() * 2;
                    if (progressValue > 90) progressValue = 90;
                }
                document.getElementById('progressFill').style.width = progressValue + '%';
            }, 500);
            
            try {
                const formData = new FormData();
                formData.append('results_folder', document.getElementById('resultsFolder').value);
                formData.append('pdf_base_folder', document.getElementById('pdfBaseFolder').value);
                
                const outputBaseDir = document.getElementById('outputBaseDir').value;
                if (outputBaseDir) {
                    formData.append('output_base_dir', outputBaseDir);
                }
                
                // æ¢å¤ä»»åŠ¡ID
                const resumeTaskId = document.getElementById('resumeTaskId').value;
                if (resumeTaskId) {
                    formData.append('resume_task_id', resumeTaskId);
                }
                
                // é€‰æ‹©APIç‰ˆæœ¬
                const useMultiprocess = document.getElementById('enableMultiprocess').checked;
                const apiEndpoint = useMultiprocess ? '/batch-process-v3' : '/batch-process-v2';
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    body: formData
                });
                
                clearInterval(progressInterval);
                document.getElementById('progressFill').style.width = '100%';
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // å¦‚æœæ˜¯V3 APIä¸”è¿”å›äº†task_idï¼Œå¯åŠ¨å®æ—¶è¿›åº¦æ›´æ–°
                    if (data.task_id && useMultiprocess) {
                        currentTaskId = data.task_id;
                        document.getElementById('taskControls').style.display = 'block';
                        document.getElementById('progressText').textContent = 'ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨å®æ—¶æ›´æ–°è¿›åº¦...';
                        
                        // å¼€å§‹å®æ—¶æ›´æ–°è¿›åº¦
                        progressTimer = setInterval(() => {
                            updateTaskProgress(currentTaskId);
                        }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
                        
                        // ç«‹å³æ›´æ–°ä¸€æ¬¡
                        updateTaskProgress(currentTaskId);
                        
                    } else {
                        // V2 APIçš„ä¼ ç»Ÿå¤„ç†æ–¹å¼
                        processedBooks = data.processed_books;
                        
                        const processedCountElement = document.getElementById('processedCount');
                        if (processedCountElement && totalBooks > 0) {
                            processedCountElement.textContent = processedBooks;
                        }
                        document.getElementById('progressText').textContent = `æ‰¹é‡å¤„ç†å®Œæˆï¼`;
                        
                        showBatchResult('success', data);
                    }
                } else {
                    const errorData = await response.json();
                    document.getElementById('progressText').textContent = 'å¤„ç†å¤±è´¥';
                    showResult('error', `
                        <h3>âŒ æ‰¹é‡å¤„ç†å¤±è´¥</h3>
                        <p>${errorData.detail}</p>
                    `);
                }
            } catch (error) {
                clearInterval(progressInterval);
                showResult('error', `
                    <h3>æ‰¹é‡å¤„ç†å¤±è´¥</h3>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `);
            } finally {
                // æ¢å¤æäº¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æ‰¹é‡å¤„ç†';
            }
        });
        
        function showResult(type, content) {
            const result = document.getElementById('result');
            result.className = `result ${type}`;
            result.innerHTML = content;
            result.style.display = 'block';
        }
        
        function showBatchResult(type, data) {
            const result = document.getElementById('result');
            result.className = `result ${type}`;
            
            let content = `
                <h3>ğŸ‰ æ‰¹é‡å¤„ç†å®Œæˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.processed_books}</div>
                        <div class="stat-label">æˆåŠŸå¤„ç†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.total_books}</div>
                        <div class="stat-label">æ€»ä¹¦ç±æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.failed_books.length}</div>
                        <div class="stat-label">å¤„ç†å¤±è´¥</div>
                    </div>
                </div>
            `;
            
            // åªæ˜¾ç¤ºæœ€æ–°çš„5ä¸ªå¤„ç†ç»“æœ
            if (data.results && data.results.length > 0) {
                const recentResults = data.results.slice(-5);  // æœ€æ–°çš„5ä¸ª
                content += '<h4>æœ€æ–°å¤„ç†ç»“æœï¼š</h4>';
                recentResults.forEach(book => {
                    const status = book.success ? 'âœ…' : 'âŒ';
                    content += `
                        <div class="book-result-simple">
                            ${status} <strong>${book.book_name}</strong>: `;
                    if (book.success) {
                        content += `${book.targets_processed} ä¸ªç›®æ ‡, ${book.images_saved} å¼ å›¾ç‰‡`;
                    } else {
                        content += book.message;
                    }
                    content += `</div>`;
                });
                
                if (data.results.length > 5) {
                    content += `<p style="color: #6c757d; font-size: 14px;">...ä»¥åŠå…¶ä»– ${data.results.length - 5} ä¸ªç»“æœ</p>`;
                }
            }
            
            result.innerHTML = content;
            result.style.display = 'block';
        }
    </script>
</body>
</html>
